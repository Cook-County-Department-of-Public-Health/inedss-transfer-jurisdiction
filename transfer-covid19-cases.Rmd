---
title: ''
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(magrittr)
library(readr)

#set inedss login credentials- only needs to be done once per user per computer
#key_set("idph_username") #IDPH username
#key_set("idph_portal") #IDPH password
#also may need to make a daily-transferred-cases folder in your directory if not already there if you want to store your logs there and don't specify where the logs go

#set pathnames
if (dir.exists("/Users/hannahsteinberg/Downloads/")){
  
  downloads_path = "/Users/hannahsteinberg/Downloads/"

} else{
  
  downloads_path = "C:/Users/Kelley/Downloads/"

}

#Source rselenium functions
source("transfer-selenium.R")
```

```{r data}

#read in list of cases that have already been transferred so we can avoid repeated transfers
already_transferred = read_csv(paste0(downloads_path, Sys.Date(), "covid_transfers.csv"),
                     col_types = cols()) %>%
  set_colnames(c("caseNumber", "transferCount")) %>%
  filter(transferCount > 0)

#read and clean BO report of cases assigned to CCDPH but have different counties listed
transfers = read_csv(paste0(downloads_path, Sys.Date(), "covid_other_counties.csv"),
                     col_types = cols()) %>%
  rename(caseNumber = `State Case Number`,
         address = `Address at Onset`,
         outbreakID = `Outbreak ID`,
         reporterComment = `Reporter Comment`,
         fips = `FIPS County`,
         county = `County at Onset`,
         currentCounty = `Current County`,
         openDate = `Open Date`) %>%
  mutate(openDate = as.Date(openDate, format = "%Y/%m/%d")) %>%
  #filter(reporterComment == "Auto case entry") %>%
  filter(county != "Cook" & fips != "17031" & 
           county != "Out Of State" & is.na(outbreakID) &
           !(caseNumber %in% already_transferred$caseNumber) &
           openDate > (Sys.Date() - 7))

```


```{r transfer}

start_server() #start selenium server
login_inedss() #login to inedss

#loop to transfer all cases in transfers dataframe
for(i in 1:nrow(transfers)){
  caseNumber = transfers$caseNumber[i]
  jurisdiction = transfers$county[i]
  
  transfer(caseNumber = caseNumber, transferTo = jurisdiction)
  wait_page("My Cases")
}

stop_server()
```

```{r jurisdiction_selections_list}
#get jurisdictions list from inside Transfer Case page of any case
# jurisdictions = rD$findElement(using = "css", value = "#jurisdiction")$selectTag()$text %>%
#   as.data.frame() %>%
#   set_colnames("selection") %>%
#   mutate(county = gsub(" County.*$| Department of Public Health| Health Department| City/County| Public Health District", "", selection),
#          county = gsub("Illinois Dept of Public Health Central Office", "IDPH", county)
#          )%>%
#   filter(!(selection %in% c("Cook County Jail for STDs Only", "Cook County Juvenile Det Center for STDs Only")))
# write_csv(jurisdictions, "jurisdiction_selections_list.csv")



```
